<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Store Management - Inventory PWA</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; transition:0.3s; }
header { background:#4CAF50; color:white; padding:15px; text-align:center; font-size:1.5em; }
main { padding:20px; max-width:900px; margin:auto; }
section { background:white; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
h2 { color:#333; margin-bottom:10px; }
label { display:block; margin:5px 0 3px; font-weight:bold; }
input, select, button { width:100%; padding:8px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; font-size:1em; }
button { background:#4CAF50; color:white; border:none; cursor:pointer; }
button:hover { background:#45a049; }
.low-stock { background:#ffdddd; padding:10px; border:1px solid #ff8888; border-radius:5px; margin-bottom:5px; }
#scanner-container { display:none; margin-bottom:10px; }

/* Dark Mode */
body.dark { background:#121212; color:#e0e0e0; }
body.dark section { background:#1e1e1e; color:#e0e0e0; }
body.dark input, body.dark select, body.dark button { background:#333; color:white; border:1px solid #555; }

/* Floating dark mode switch */
#darkModeSwitch {
    position: fixed;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: #4CAF50;
    border-radius: 50px;
    width: 50px;
    height: 50px;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: white;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
/* Dark Mode */
body.dark { 
  background:#121212; 
  color:#e0e0e0; 
}

body.dark section { 
  background:#1e1e1e; 
  color:#e0e0e0; 
}

body.dark h2,
body.dark label,
body.dark th {   /* âœ… headings, labels, table headers */
  color:#ffffff;
}

body.dark input, 
body.dark select, 
body.dark button { 
  background:#333; 
  color:white; 
  border:1px solid #555; 
}

body.dark button:hover {
  background:#555;  /* âœ… softer hover in dark mode */
}

body.dark .low-stock {
  background:#662222;  /* âœ… darker red background */
  border:1px solid #aa4444;
  color:#ffaaaa;
}
    
</style>
</head>
<body>

<header>ðŸ“¦ Store Management</header>
<button id="darkModeSwitch" onclick="toggleDarkMode()">ðŸŒ™</button>

<main>
<section>
<h2><button onclick="toggleAddItem()" style="background:#4CAF50;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;">âž• Add New Item</button></h2>
<div id="addItemSection" style="display:none; margin-top:10px;">
<label>Category</label>
<input type="text" id="category" placeholder="e.g., Beverages">
<label>Subcategory</label>
<input type="text" id="subcategory" placeholder="e.g., Soft Drinks">
<label>Item Name</label>
<input type="text" id="itemName" placeholder="e.g., Coca-Cola 50cl">
<label>Quantity</label>
<input type="number" id="quantity" min="1" placeholder="Enter quantity">
<button id="addItemBtn">âž• Add Item</button>
</div>
</section>

<section>
<h2>Update Stock</h2>
<label>Select Item</label>
<select id="updateItemSelect"></select>
<label>Additional Quantity</label>
<input type="number" id="updateQuantity" min="1">
<button id="updateStockBtn">ðŸ“¥ Add Stock</button>
</section>

<section>
<h2>Sell Item</h2>
<button id="startScannerBtn">ðŸ“· Scan Barcode</button>
<div id="scanner-container"></div>
<label>Or Select Item</label>
<select id="sellItemSelect"></select>
<label>Quantity Sold</label>
<input type="number" id="sellQuantity" min="1">
<button id="sellItemBtn">ðŸ’° Sell</button>
<input type="hidden" id="sellBarcode">
</section>

<section>
<h2>âš  Low Stock Alerts</h2>
<div id="lowStockList">No low stock items.</div>
</section>

</main>

<!-- JS Libraries -->
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
    // Dark mode toggle
function toggleDarkMode() {
    document.body.classList.toggle("dark");
}

// Initialize Dexie DB
const db = new Dexie("InventoryDB");
db.version(1).stores({
    items: '++id, category, subcategory, itemName, quantity, sold, barcode, sales'
});

// Generate unique 8-digit barcode
function generateBarcode() {
    return Math.floor(10000000 + Math.random() * 90000000).toString();
}

// Collapsible Add Item section
function toggleAddItem() {
    const section = document.getElementById('addItemSection');
    section.style.display = section.style.display === "none" ? "block" : "none";
}

// Refresh dropdowns & low stock
async function refreshSelectOptions() {
    const allItems = await db.items.toArray();
    const updateSelect = document.getElementById('updateItemSelect');
    const sellSelect = document.getElementById('sellItemSelect');
    updateSelect.innerHTML = "";
    sellSelect.innerHTML = "";

    allItems.forEach(item => {
        const option = new Option(`${item.itemName} (${item.quantity})`, item.id);
        updateSelect.add(option.cloneNode(true));
        sellSelect.add(option.cloneNode(true));
    });

    checkLowStock();
}

// Notify low stock using Notification API
async function notifyLowStock(item) {
    if ("Notification" in window && Notification.permission === "granted") {
        new Notification("Low Stock Alert", { body: `${item.itemName} has only ${item.quantity} left!` });
    }
}

// Check and display low stock items
async function checkLowStock() {
    const lowStockList = document.getElementById('lowStockList');
    lowStockList.innerHTML = "";
    const allItems = await db.items.toArray();
    let hasLow = false;

    allItems.forEach(item => {
        if (item.quantity < 5) {
            hasLow = true;
            const div = document.createElement('div');
            div.className = 'low-stock';
            div.textContent = `${item.itemName} - Only ${item.quantity} left!`;
            lowStockList.appendChild(div);
            notifyLowStock(item);
        }
    });

    if (!hasLow) lowStockList.textContent = "No low stock items.";
}

// Add new item
document.getElementById('addItemBtn').addEventListener('click', async () => {
    const category = document.getElementById('category').value;
    const subcategory = document.getElementById('subcategory').value;
    const itemName = document.getElementById('itemName').value;
    const quantity = parseInt(document.getElementById('quantity').value);

    if (!category || !itemName || !quantity) {
        alert("Please fill all required fields");
        return;
    }

    const barcode = generateBarcode();
    await db.items.add({ category, subcategory, itemName, quantity, sold: 0, barcode, sales: [] });
    alert(`Item added successfully! Barcode: ${barcode}`);
    refreshSelectOptions();
    document.getElementById('category').value = "";
    document.getElementById('subcategory').value = "";
    document.getElementById('itemName').value = "";
    document.getElementById('quantity').value = "";
});

// Update stock
document.getElementById('updateStockBtn').addEventListener('click', async () => {
    const id = parseInt(document.getElementById('updateItemSelect').value);
    const addQty = parseInt(document.getElementById('updateQuantity').value);
    if (!id || !addQty) return;
    const item = await db.items.get(id);
    await db.items.update(id, { quantity: item.quantity + addQty });
    alert("Stock updated!");
    document.getElementById('updateQuantity').value = "";
    refreshSelectOptions();
});

// Sell item
document.getElementById('sellItemBtn').addEventListener('click', async () => {
    const sellBarcode = document.getElementById('sellBarcode').value;
    let id = parseInt(document.getElementById('sellItemSelect').value);
    const sellQty = parseInt(document.getElementById('sellQuantity').value);
    if (!sellQty) return;

    if (sellBarcode) {
        const itemByBarcode = await db.items.where("barcode").equals(sellBarcode).first();
        if (!itemByBarcode) { alert("Barcode not found"); return; }
        id = itemByBarcode.id;
    }

    if (!id) { alert("Select item"); return; }

    const item = await db.items.get(id);
    if (item.quantity >= sellQty) {
        const updatedSales = item.sales ? [...item.sales, { date: new Date().toISOString().slice(0, 10), qty: sellQty }] : [{ date: new Date().toISOString().slice(0, 10), qty: sellQty }];
        await db.items.update(id, { quantity: item.quantity - sellQty, sold: item.sold + sellQty, sales: updatedSales });
        alert("Sale recorded!");
        document.getElementById('sellQuantity').value = "";
        document.getElementById('sellBarcode').value = "";
        refreshSelectOptions();
    } else {
        alert("Not enough stock!");
    }
});

// Start barcode scanner
document.getElementById('startScannerBtn').addEventListener('click', () => {
    const container = document.getElementById('scanner-container');
    container.style.display = "block";

    Quagga.init({
        inputStream: { type: "LiveStream", target: container, constraints: { facingMode: "environment" } },
        decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader"] }
    }, function (err) {
        if (err) { console.error(err); return; }
        Quagga.start();
    });

    Quagga.onDetected(async function (result) {
        const code = result.codeResult.code;
        document.getElementById('sellBarcode').value = code;
        Quagga.stop();
        container.style.display = "none";
    });
});

// Initialize
(async () => {
    await refreshSelectOptions();
})();

// Request notification permission
if ("Notification" in window) Notification.requestPermission();

// Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(registration => console.log('Service Worker registered:', registration.scope))
            .catch(err => console.log('Service Worker registration failed:', err));
    });
}
    </script>

</body>

</html>
