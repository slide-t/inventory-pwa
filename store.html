<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Store Management - Inventory PWA</title>
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; transition:0.3s; }
    header { background:#4CAF50; color:white; padding:15px; text-align:center; font-size:1.5em; }
    main { padding:20px; max-width:900px; margin:auto; }
    section { background:white; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    h2 { color:#333; margin-bottom:10px; }
    label { display:block; margin:5px 0 3px; font-weight:bold; }
    input, select, button { width:100%; padding:8px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; font-size:1em; }
    button { background:#4CAF50; color:white; border:none; cursor:pointer; }
    button:hover { background:#45a049; }
    .low-stock { background:#ffdddd; padding:10px; border:1px solid #ff8888; border-radius:5px; margin-bottom:5px; }
    #scanner-container { display:none; margin-bottom:10px; }

    /* Dark Mode */
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark section { background:#1e1e1e; color:#e0e0e0; }
    body.dark input, body.dark select, body.dark button { background:#333; color:white; border:1px solid #555; }

    /* Floating dark mode switch */
    #darkModeSwitch {
        position: fixed;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #4CAF50;
        border-radius: 50px;
        width: 50px;
        height: 50px;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: white;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
</style>
</head>
<body>

<header>ðŸ“¦ Store Management</header>

<!-- Floating Dark Mode Switch -->
<button id="darkModeSwitch" onclick="toggleDarkMode()">ðŸŒ™</button>

<main>
    <!-- Collapsible Add Item Section -->
    <section>
        <h2>
            <button onclick="toggleAddItem()" style="background:#4CAF50;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;">
                âž• Add New Item
            </button>
        </h2>
        <div id="addItemSection" style="display:none; margin-top:10px;">
            <label>Category</label>
            <input type="text" id="category" placeholder="e.g., Beverages">

            <label>Subcategory</label>
            <input type="text" id="subcategory" placeholder="e.g., Soft Drinks">

            <label>Item Name</label>
            <input type="text" id="itemName" placeholder="e.g., Coca-Cola 50cl">

            <label>Quantity</label>
            <input type="number" id="quantity" min="1" placeholder="Enter quantity">

            <label>Barcode</label>
            <input type="text" id="barcode" placeholder="Scan or enter barcode">

            <button onclick="addItem()">âž• Add Item</button>
        </div>
    </section>

    <!-- Update Stock -->
    <section>
        <h2>Update Stock</h2>
        <label>Select Item</label>
        <select id="updateItemSelect"></select>

        <label>Additional Quantity</label>
        <input type="number" id="updateQuantity" min="1">

        <button onclick="updateStock()">ðŸ“¥ Add Stock</button>
    </section>

    <!-- Sell Item -->
    <section>
        <h2>Sell Item</h2>
        <button onclick="startScanner()">ðŸ“· Scan Barcode</button>
        <div id="scanner-container"></div>

        <label>Or Select Item</label>
        <select id="sellItemSelect"></select>

        <label>Quantity Sold</label>
        <input type="number" id="sellQuantity" min="1">

        <button onclick="sellItem()">ðŸ’° Sell</button>
        <input type="hidden" id="sellBarcode">
    </section>

    <!-- Low Stock Alerts -->
    <section>
        <h2>âš  Low Stock Alerts</h2>
        <div id="lowStockList">No low stock items.</div>
    </section>
</main>

<!-- Libraries -->
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
    // Dark mode toggle
    function toggleDarkMode(){ document.body.classList.toggle("dark"); }

    // IndexedDB using Dexie
    const db = new Dexie("InventoryDB");
    db.version(1).stores({
        items: '++id, category, subcategory, itemName, quantity, sold, barcode, sales'
    });

    // Collapsible Add Item
    function toggleAddItem() {
        const section = document.getElementById('addItemSection');
        section.style.display = section.style.display === "none" ? "block" : "none";
    }

    // Refresh dropdowns
    async function refreshSelectOptions() {
        const allItems = await db.items.toArray();
        const updateSelect = document.getElementById('updateItemSelect');
        const sellSelect = document.getElementById('sellItemSelect');
        updateSelect.innerHTML = "";
        sellSelect.innerHTML = "";
        allItems.forEach(item => {
            const option = new Option(`${item.itemName} (${item.quantity})`, item.id);
            updateSelect.add(option.cloneNode(true));
            sellSelect.add(option.cloneNode(true));
        });
        checkLowStock();
    }

    // Notify low stock via Service Worker
    async function notifyLowStock(item){
        if('serviceWorker' in navigator && navigator.serviceWorker.controller){
            navigator.serviceWorker.controller.postMessage({
                type:'LOW_STOCK_ALERT',
                itemName:item.itemName,
                quantity:item.quantity
            });
        } else if("Notification" in window){
            new Notification("Low Stock Alert",{body:`${item.itemName} has only ${item.quantity} left!`});
        }
    }

    // Check low stock
    async function checkLowStock() {
        const lowStockList = document.getElementById('lowStockList');
        lowStockList.innerHTML="";
        const allItems = await db.items.toArray();
        let hasLow=false;
        allItems.forEach(item=>{
            if(item.quantity<5){
                hasLow=true;
                const div = document.createElement('div');
                div.className='low-stock';
                div.textContent=`${item.itemName} - Only ${item.quantity} left!`;
                lowStockList.appendChild(div);
                notifyLowStock(item);
            }
        });
        if(!hasLow) lowStockList.textContent="No low stock items.";
    }

    // Add Item
    async function addItem() {
        const category = document.getElementById('category').value;
        const subcategory = document.getElementById('subcategory').value;
        const itemName = document.getElementById('itemName').value;
        const quantity = parseInt(document.getElementById('quantity').value);
        const barcode = document.getElementById('barcode').value;
        if(!category || !itemName || !quantity){ alert("Please fill all required fields"); return; }
        await db.items.add({ category, subcategory, itemName, quantity, sold:0, barcode, sales:[] });
        alert("Item added successfully!");
        refreshSelectOptions(); clearAddForm();
    }

    function clearAddForm(){
        document.getElementById('category').value="";
        document.getElementById('subcategory').value="";
        document.getElementById('itemName').value="";
        document.getElementById('quantity').value="";
        document.getElementById('barcode').value="";
    }

    // Update stock
    async function updateStock(){
        const id=parseInt(document.getElementById('updateItemSelect').value);
        const addQty=parseInt(document.getElementById('updateQuantity').value);
        if(!id || !addQty) return;
        const item=await db.items.get(id);
        await db.items.update(id,{quantity:item.quantity+addQty});
        alert("Stock updated!");
        document.getElementById('updateQuantity').value="";
        refreshSelectOptions();
    }

    // Sell item
    async function sellItem(){
        let sellBarcode = document.getElementById('sellBarcode').value;
        let id=parseInt(document.getElementById('sellItemSelect').value);
        const sellQty=parseInt(document.getElementById('sellQuantity').value);
        if(!sellQty) return;

        if(sellBarcode){
            const item=await db.items.where("barcode").equals(sellBarcode).first();
            if(!item){ alert("Barcode not found"); return; }
            id=item.id;
        }
        if(!id){ alert("Select item"); return; }

        const item=await db.items.get(id);
        if(item.quantity>=sellQty){
            const updatedSales=item.sales?[...item.sales,{date:new Date().toISOString().slice(0,10),qty:sellQty}]:[{date:new Date().toISOString().slice(0,10),qty:sellQty}];
            await db.items.update(id,{quantity:item.quantity-sellQty, sold:item.sold+sellQty, sales:updatedSales});
            alert("Sale recorded!");
            document.getElementById('sellQuantity').value="";
            document.getElementById('sellBarcode').value="";
            refreshSelectOptions();
        } else { alert("Not enough stock!"); }
    }

    // Barcode scanner
    function startScanner(){
        const container=document.getElementById('scanner-container');
        container.style.display="block";

        Quagga.init({
            inputStream:{type:"LiveStream",target:container,constraints:{facingMode:"environment"}},
            decoder:{readers:["code_128_reader","ean_reader","ean_8_reader"]}
        },function(err){
            if(err){ console.error(err); return; }
            Quagga.start();
        });

        Quagga.onDetected(async function(result){
            const code=result.codeResult.code;
            document.getElementById('sellBarcode').value=code;
            Quagga.stop(); container.style.display="none";
        });
    }

    // Initialize
    (async()=>{ await refreshSelectOptions(); })();

    // Request notification permission
    if("Notification" in window){ Notification.requestPermission(); }

    // Register Service Worker
    if('serviceWorker' in navigator){
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
            .then(registration => console.log('Service Worker registered:', registration.scope))
            .catch(err => console.log('Service Worker registration failed:', err));
        });
    }
</script>
</body>
</html>
