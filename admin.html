<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Inventory PWA</title>
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
    header { background:#2c3e50; color:white; padding:15px; text-align:center; font-size:1.5em; }
    main { padding:20px; max-width:1000px; margin:auto; }
    section { background:white; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin-top:0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#f2f2f2; }
    .stats { display:flex; gap:1rem; margin-top:10px; }
    .stat-box { flex:1; background:#ecf0f1; padding:10px; border-radius:5px; text-align:center; font-weight:bold; }
    input, select, button { padding:6px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
    button { background:#2c3e50; color:white; cursor:pointer; }
    button:hover { background:#34495e; }
</style>
</head>
<body>

<header>ðŸ“Š Admin Dashboard</header>

<main>

    <!-- Filters -->
    <section>
        <h2>Filter Sales</h2>
        <label>Item Name</label>
        <input type="text" id="filterItemName" placeholder="Search by item name">

        <label>Date Range</label>
        <input type="date" id="startDate"> to <input type="date" id="endDate">

        <button onclick="applyFilters()">Apply Filters</button>
    </section>

    <!-- Inventory Overview -->
    <section>
        <h2>Inventory Overview</h2>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Subcategory</th>
                    <th>Item</th>
                    <th>In Stock</th>
                    <th>Sold</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody"></tbody>
        </table>
    </section>

    <!-- Sales Stats -->
    <section>
        <h2>Sales Stats</h2>
        <div class="stats">
            <div class="stat-box">Total Sales Today: <span id="dailySales">0</span></div>
            <div class="stat-box">Total Sales This Week: <span id="weeklySales">0</span></div>
        </div>
    </section>

    <!-- Sales History -->
    <section>
        <h2>Sales History</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Item</th>
                    <th>Quantity Sold</th>
                </tr>
            </thead>
            <tbody id="salesHistoryAdmin"></tbody>
        </table>
    </section>

</main>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <section>
    <h2>ðŸ“„ Export Reports</h2>
    <button onclick="exportInventoryPDF()">Export Inventory to PDF</button>
    <button onclick="exportSalesPDF()">Export Sales to PDF</button>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    const { jsPDF } = window.jspdf;

    async function exportInventoryPDF() {
        if(!confirm("Do you want to download the Inventory PDF?")) return;

        const items = await db.items.toArray();
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("Inventory Report", 14, 20);
        let y = 30;

        items.forEach(i => {
            const line = `Category: ${i.category}, Subcategory: ${i.subcategory}, Item: ${i.itemName}, Qty: ${i.quantity}, Sold: ${i.sold}`;
            doc.text(line, 14, y);
            y += 10;
            if(y > 280){ doc.addPage(); y=20; } // new page if overflow
        });

        doc.save("Inventory_Report.pdf");
    }

    async function exportSalesPDF() {
        if(!confirm("Do you want to download the Sales PDF?")) return;

        const items = await db.items.toArray();
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("Sales Report", 14, 20);
        let y = 30;

        items.forEach(i => {
            i.sales.forEach(s => {
                const line = `Item: ${i.itemName}, Qty Sold: ${s.qty}, Date: ${s.date}`;
                doc.text(line, 14, y);
                y += 10;
                if(y > 280){ doc.addPage(); y=20; }
            });
        });

        doc.save("Sales_Report.pdf");
    }
</script>
    
    <!--
    <script>
    async function exportInventory() {
        const items = await db.items.toArray();
        const data = items.map(i => ({
            Category: i.category,
            Subcategory: i.subcategory,
            ItemName: i.itemName,
            Quantity: i.quantity,
            Sold: i.sold,
            Barcode: i.barcode
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventory");
        XLSX.writeFile(wb, "Inventory_Report.xlsx");
    }

    async function exportSales() {
        const items = await db.items.toArray();
        let salesData = [];
        items.forEach(i => {
            i.sales.forEach(s => {
                salesData.push({
                    ItemName: i.itemName,
                    QuantitySold: s.qty,
                    Date: s.date
                });
            });
        });
        const ws = XLSX.utils.json_to_sheet(salesData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales");
        XLSX.writeFile(wb, "Sales_Report.xlsx");
    }
</script>
    -->
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script>
    // Initialize IndexedDB using Dexie
    const db = new Dexie("InventoryDB");
    db.version(1).stores({
        items: '++id, category, subcategory, itemName, quantity, sold, barcode, sales'
    });

    // Sample data (if DB empty)
    async function initData() {
        const count = await db.items.count();
        if (count === 0) {
            await db.items.bulkAdd([
                {category:"Electronics", subcategory:"Phone", itemName:"iPhone 14", quantity:10, sold:3, barcode:"111", sales:[{date:"2025-08-15", qty:2},{date:"2025-08-16", qty:1}]},
                {category:"Groceries", subcategory:"Rice", itemName:"Golden Rice 5kg", quantity:20, sold:5, barcode:"222", sales:[{date:"2025-08-15", qty:3},{date:"2025-08-16", qty:2}]},
                {category:"Clothing", subcategory:"T-Shirt", itemName:"Polo Shirt", quantity:15, sold:4, barcode:"333", sales:[{date:"2025-08-16", qty:4}]}
            ]);
        }
    }

    async function loadInventory() {
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        inventoryTableBody.innerHTML = "";
        const allItems = await db.items.toArray();
        allItems.forEach(item => {
            inventoryTableBody.innerHTML += `
                <tr>
                    <td>${item.category}</td>
                    <td>${item.subcategory}</td>
                    <td>${item.itemName}</td>
                    <td>${item.quantity}</td>
                    <td>${item.sold}</td>
                </tr>
            `;
        });
    }

    async function calculateSales() {
        const dailyElem = document.getElementById('dailySales');
        const weeklyElem = document.getElementById('weeklySales');
        let today = new Date().toISOString().slice(0,10);
        let weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
        let dailyTotal = 0, weeklyTotal = 0;

        const allItems = await db.items.toArray();
        allItems.forEach(item => {
            if(item.sales){
                item.sales.forEach(sale=>{
                    let saleDate = new Date(sale.date);
                    if(sale.date===today) dailyTotal += sale.qty;
                    if(saleDate>=weekAgo) weeklyTotal += sale.qty;
                });
            }
        });

        dailyElem.textContent = dailyTotal;
        weeklyElem.textContent = weeklyTotal;
    }

    async function loadSalesHistory(filterName="", start="", end="") {
        const tbody = document.getElementById('salesHistoryAdmin');
        tbody.innerHTML = "";
        const allItems = await db.items.toArray();
        let hasData=false;

        allItems.forEach(item=>{
            if(item.sales){
                item.sales.forEach(sale=>{
                    let saleDate = new Date(sale.date);
                    let show = true;
                    if(filterName && !item.itemName.toLowerCase().includes(filterName.toLowerCase())) show=false;
                    if(start && saleDate<new Date(start)) show=false;
                    if(end && saleDate>new Date(end)) show=false;
                    if(show){
                        hasData=true;
                        tbody.innerHTML += `<tr>
                            <td>${sale.date}</td>
                            <td>${item.itemName}</td>
                            <td>${sale.qty}</td>
                        </tr>`;
                    }
                });
            }
        });

        if(!hasData) tbody.innerHTML="<tr><td colspan='3'>No sales data for filter</td></tr>";
    }

    function applyFilters() {
        const name = document.getElementById('filterItemName').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        loadSalesHistory(name, start, end);
    }

    // Initialize page
    (async ()=>{
        await initData();
        await loadInventory();
        await calculateSales();
        await loadSalesHistory();
    })();
</script>
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
        }).catch(err => {
            console.log('Service Worker registration failed:', err);
        });
    });
}
</script>
</body>
</html>
