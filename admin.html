<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Inventory PWA</title>
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; transition:0.3s; }
    header { background:#2c3e50; color:white; padding:15px; text-align:center; font-size:1.5em; }
    main { padding:20px; max-width:1000px; margin:auto; }

    section { background:white; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin-top:0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#f2f2f2; }
    .stats { display:flex; flex-wrap:wrap; gap:1rem; margin-top:10px; }
    .stat-box { flex:1; background:#ecf0f1; padding:10px; border-radius:5px; text-align:center; font-weight:bold; }

    input, select, button { padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
    button { background:#2c3e50; color:white; cursor:pointer; }
    button:hover { background:#34495e; }

    /* Responsive layout */
    @media(min-width:768px){
        .stats { flex-wrap:nowrap; }
        input, select, button { width:auto; }
    }

    /* Dark mode */
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark section { background:#1e1e1e; color:#e0e0e0; }
    body.dark input, body.dark select, body.dark button { background:#333; color:white; border:1px solid #555; }
</style>
</head>
<body>
<header>ðŸ“Š Admin Dashboard</header>

<main>
    <!-- Filters -->
    <section>
        <h2>Filter Sales</h2>
        <input type="text" id="filterItemName" placeholder="Search by item name">
        <label>Date Range</label>
        <input type="date" id="startDate"> to <input type="date" id="endDate">
        <button onclick="applyFilters()">Apply Filters</button>
    </section>

    <!-- Inventory Overview -->
    <section>
        <h2>Inventory Overview</h2>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Subcategory</th>
                    <th>Item</th>
                    <th>In Stock</th>
                    <th>Sold</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody"></tbody>
        </table>
    </section>

    <!-- Sales Stats -->
    <section>
        <h2>Sales Stats</h2>
        <div class="stats">
            <div class="stat-box">Total Sales Today: <span id="dailySales">0</span></div>
            <div class="stat-box">Total Sales This Week: <span id="weeklySales">0</span></div>
        </div>
    </section>

    <!-- Sales History -->
    <section>
        <h2>Sales History</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Item</th>
                    <th>Quantity Sold</th>
                </tr>
            </thead>
            <tbody id="salesHistoryAdmin"></tbody>
        </table>
    </section>

    <!-- Export Reports -->
    <section>
        <h2>ðŸ“„ Export Reports</h2>
        <button onclick="exportInventoryPDF()">Export Inventory PDF</button>
        <button onclick="exportSalesPDF()">Export Sales PDF</button>
    </section>
</main>

<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// IndexedDB
const db = new Dexie("InventoryDB");
db.version(1).stores({
    items: '++id, category, subcategory, itemName, quantity, sold, barcode, sales'
});

// Load inventory table
async function loadInventory(){
    const tbody=document.getElementById('inventoryTableBody');
    tbody.innerHTML="";
    const items=await db.items.toArray();
    items.forEach(item=>{
        tbody.innerHTML+=`<tr>
            <td>${item.category}</td>
            <td>${item.subcategory}</td>
            <td>${item.itemName}</td>
            <td>${item.quantity}</td>
            <td>${item.sold}</td>
        </tr>`;
    });
}

// Calculate sales
async function calculateSales(){
    const dailyElem=document.getElementById('dailySales');
    const weeklyElem=document.getElementById('weeklySales');
    let today=new Date().toISOString().slice(0,10);
    let weekAgo=new Date(); weekAgo.setDate(weekAgo.getDate()-7);
    let dailyTotal=0, weeklyTotal=0;
    const items=await db.items.toArray();
    items.forEach(item=>{
        item.sales?.forEach(sale=>{
            const saleDate=new Date(sale.date);
            if(sale.date===today) dailyTotal+=sale.qty;
            if(saleDate>=weekAgo) weeklyTotal+=sale.qty;
        });
    });
    dailyElem.textContent=dailyTotal;
    weeklyElem.textContent=weeklyTotal;
}

// Load sales history with filter
async function loadSalesHistory(filterName="", start="", end=""){
    const tbody=document.getElementById('salesHistoryAdmin');
    tbody.innerHTML="";
    const items=await db.items.toArray();
    let hasData=false;
    items.forEach(item=>{
        item.sales?.forEach(sale=>{
            const saleDate=new Date(sale.date);
            let show=true;
            if(filterName && !item.itemName.toLowerCase().includes(filterName.toLowerCase())) show=false;
            if(start && saleDate<new Date(start)) show=false;
            if(end && saleDate>new Date(end)) show=false;
            if(show){
                hasData=true;
                tbody.innerHTML+=`<tr>
                    <td>${sale.date}</td>
                    <td>${item.itemName}</td>
                    <td>${sale.qty}</td>
                </tr>`;
            }
        });
    });
    if(!hasData) tbody.innerHTML="<tr><td colspan='3'>No sales data for filter</td></tr>";
}

// Apply filters
function applyFilters(){
    const name=document.getElementById('filterItemName').value;
    const start=document.getElementById('startDate').value;
    const end=document.getElementById('endDate').value;
    loadSalesHistory(name,start,end);
}

// Export PDFs
async function exportInventoryPDF(){
    if(!confirm("Do you want to download the Inventory PDF?")) return;
    const items=await db.items.toArray();
    const doc=new jsPDF();
    doc.setFontSize(14); doc.text("Inventory Report",14,20);
    let y=30;
    items.forEach(i=>{
        doc.text(`Category: ${i.category}, Subcategory: ${i.subcategory}, Item: ${i.itemName}, Qty: ${i.quantity}, Sold: ${i.sold}`,14,y);
        y+=10; if(y>280){ doc.addPage(); y=20; }
    });
    doc.save("Inventory_Report.pdf");
}

async function exportSalesPDF(){
    if(!confirm("Do you want to download the Sales PDF?")) return;
    const items=await db.items.toArray();
    const doc=new jsPDF();
    doc.setFontSize(14); doc.text("Sales Report",14,20);
    let y=30;
    items.forEach(i=>{
        i.sales?.forEach(s=>{
            doc.text(`Item: ${i.itemName}, Qty Sold: ${s.qty}, Date: ${s.date}`,14,y);
            y+=10; if(y>280){ doc.addPage(); y=20; }
        });
    });
    doc.save("Sales_Report.pdf");
}

// Auto-delete old sales after 2 weeks with confirmation
async function autoDeleteOldSales(){
    const twoWeeksAgo=new Date(); twoWeeksAgo.setDate(twoWeeksAgo.getDate()-14);
    if(!confirm("Do you want to delete sales older than 2 weeks? Make sure to export first!")) return;
    const items=await db.items.toArray();
    for(const item of items){
        const filteredSales=item.sales?.filter(s=>new Date(s.date)>=twoWeeksAgo) || [];
        await db.items.update(item.id,{sales:filteredSales});
    }
    alert("Old sales records deleted!");
    loadInventory(); calculateSales(); loadSalesHistory();
}

// Initialize
(async ()=>{
    await loadInventory();
    await calculateSales();
    await loadSalesHistory();
    // Run auto-delete prompt every page load
    setTimeout(autoDeleteOldSales,1000);
})();
</script>

<script>
if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
        navigator.serviceWorker.register('sw.js')
        .then(reg=>console.log('Service Worker registered:',reg.scope))
        .catch(err=>console.log('SW registration failed:',err));
    });
}
</script>
</body>
</html>
